<!doctype html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="https://studio3d-sit.anker-in.com/anker-viewer/icons/logo.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Anker3D-环境贴图和背景设置</title>
  <link type="text/css" rel="stylesheet" href="style/main.css">
</head>
<body>

<div id="anker-viewer"></div>
<script type="module">
  //引入SDK
  import * as Anker3D from "../src/index.ts"

  //获取容器
  const container = document.getElementById('anker-viewer');

  //创建查看器
  const viewer = new Anker3D.Viewer(container,{
    modelParams:{
      urlOrId:'M3EF684585',//三维平台模型id
    }
  });

  // 挂载到全局 window 对象，便于调试
  window.viewer = viewer;
  window.Anker3D = Anker3D;

  createDebugGUI();
  //创建调试UI
  function createDebugGUI() {
    const debugPanel = new Anker3D.GUI()
    // 背景色参数
    const debugParams = {
      background: '#242424',
      showHelper: false,
      environment: "S1pro.hdr",
      environmentIntensity:1,
      environmentRotationX:0,
      environmentRotationY:0,
      environmentRotationZ:0,
      toneMapping: Anker3D.NeutralToneMapping,
      toneMappingExposure: 1.0,
      hdrAsBackground: true, // 新增：是否用HDR作为背景
      addView:()=>{},
      view:''
    }

    const HDR_ENV_LIST = ["A2697.hdr", "A110B.hdr","A3874.hdr","aircraft_workshop_01_1k.hdr","lebombo_1k.hdr",
      "lightroom_14b.hdr","moon_1k.hdr","moon_4k.hdr","music_hall_01_1k.hdr","neutral.hdr","pillars_1k.hdr",
      "S1pro.hdr", "spot1Lux.hdr","spruit_sunrise_1k_HDR.hdr","studio_small_01_1k.hdr",
      "whipple_creek_regional_park_04_1k.hdr", "white_furnace.hdr"];
    const toneMappingOptions = [
      { name: 'No', value: Anker3D.NoToneMapping },
      { name: 'Linear', value: Anker3D.LinearToneMapping },
      { name: 'Reinhard', value: Anker3D.ReinhardToneMapping },
      { name: 'Cineon', value: Anker3D.CineonToneMapping },
      { name: 'ACESFilmic', value: Anker3D.ACESFilmicToneMapping },
      { name: 'AgX', value: Anker3D.AgXToneMapping },
      { name: 'Neutral', value: Anker3D.NeutralToneMapping },
      { name: 'Custom', value: Anker3D.CustomToneMapping },
    ];

    const envFolder = debugPanel.addFolder('环境/光线设置');
    envFolder.open();

    // HDR作为背景checkbox
    envFolder.add(debugParams, 'hdrAsBackground')
            .name('HDR作为背景')
            .onChange((checked) => {
              if (checked) {
                // 用当前HDR作为背景
                viewer.scene.setBackground(viewer.scene.environment);
              }
              else {
                // 用当前纯色作为背景
                viewer.scene.setBackground(debugParams.background);
              }
            });
    // 背景色控制器
    envFolder.addColor(debugParams, 'background').name('Background')
            .onChange((value) => {
              if (!debugParams.hdrAsBackground) {
                viewer.scene.setBackground(value)
              }
            })
    // HDR环境选择
    envFolder.add(debugParams, 'environment', HDR_ENV_LIST)
            .name('环境反射贴图')
            .onChange((value) => {
              viewer.scene.loadEnvironmentMap(`../environments/${value}`, debugParams.hdrAsBackground)
            })
    envFolder.add(debugParams, 'environmentIntensity', 0, 2, 0.01)
            .name('环境反射强度')
            .onChange((value) => {
              viewer.scene.environmentIntensity = value;
            })

    const environmentRotationFolder = envFolder.addFolder('反射角度');
    environmentRotationFolder.open();
    environmentRotationFolder.add(debugParams, 'environmentRotationX', 0, Math.PI, 0.01)
            .name('x')
            .onChange((value) => {
              viewer.scene.environmentRotation.x = value;
            })
    environmentRotationFolder.add(debugParams, 'environmentRotationY', 0, Math.PI, 0.01)
            .name('y')
            .onChange((value) => {
              viewer.scene.environmentRotation.y = value;
            })
    environmentRotationFolder.add(debugParams, 'environmentRotationZ', 0, Math.PI, 0.01)
            .name('z')
            .onChange((value) => {
              viewer.scene.environmentRotation.z = value;
            })
    // 色调映射
    envFolder.add(
            debugParams,
            'toneMapping',
            toneMappingOptions.reduce((obj, item) => {
              obj[item.name] = item.value
              return obj
            }, {})
    )
            .name('色调映射')
            .onChange((value) => {
              viewer.renderManager.toneMapping = Number(value);
            })
    // 曝光
    envFolder.add(debugParams, 'toneMappingExposure', 0, 2, 0.01)
            .name('曝光')
            .onChange((value) => {
              viewer.renderManager.toneMappingExposure = value;
            })

  }

</script>
</body>
</html>
